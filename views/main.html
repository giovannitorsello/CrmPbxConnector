<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>CrmPbx - Wifinetcom 2018 TM</title>
  <link rel="stylesheet" href="static/css/bootstrap.min.css">
  <link rel="stylesheet" href="static/css/tempusdominus-bootstrap-4.min.css">
  <link rel="stylesheet" href="static/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" href="static/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="static/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="static/css/wait_modal.css">
  <link rel="stylesheet" href="static/css/main.css">


  <script src="static/js/jquery.min.js"></script>
  <script src="static/js/moment.min.js"></script>
  <script src="static/js/popper.min.js"></script>
  <script src="static/js/bootstrap.min.js"></script>
  <script src="static/js/moment.js"></script>
  <script src="static/js/moment-it.js"></script>
  <script src="static/js/tempusdominus-bootstrap-4.min.js"></script>
  <script src="static/js/jquery.dataTables.min.js"></script>
  <script src="static/js/dataTables.buttons.min.js"></script>
  <script src="static/js/buttons.flash.min.js"></script>
  <script src="static/js/jszip.min.js"></script>
  <script src="static/js/pdfmake.min.js"></script>
  <script src="static/js/vfs_fonts.js"></script>
  <script src="static/js/buttons.html5.min.js"></script>
  <script src="static/js/buttons.print.min.js"></script>


</head>

<body id="Main">
  <div class="container">
    <h1 class="form-heading">Pbx Monitor</h1>
    <div class="modal_wait_for_search" id="modal_wait_for_search"></div>
    <form id="SearchCalls" action="/search_calls" method="post">
      <div class="form-group row">

        <div class="col-xs-2 start_date">
          <label for="start_date">Inizio</label>
          <div class="input-group date" id="start_date_div" data-target-input="nearest">
            <input type="text" class="form-control datetimepicker-input" data-target="#start_date" id="start_date" name="start_date" />
            <div class="input-group-append" data-target="#start_date" data-toggle="datetimepicker">
              <div class="input-group-text"><i class="fa fa-calendar"></i></div>
            </div>
          </div>
        </div>

        <div class="col-xs-2 end_date">
          <label for="end_date">Fine</label>
          <div class="input-group date" id="end_date_div" data-target-input="nearest">
            <input type="text" class="form-control datetimepicker-input" data-target="#end_date" id="end_date" name="end_date" />
            <div class="input-group-append" data-target="#end_date" data-toggle="datetimepicker">
              <div class="input-group-text"><i class="fa fa-calendar"></i></div>
            </div>
          </div>
        </div>

        <div class="col-xs-2 div_call_type">
          <label for="call_type">Ingresso/Uscita</label>
          <select class="form-control" id="call_type" name="call_type">
            <option></option>
            <option>ingresso</option>
            <option>uscita</option>
          </select>
        </div>
      </div>

      <div class="form-group row">
        <div class="col-xs-2 div_internal_phone_number">
          <label for="internal_phone_number">Interno</label>
          <select class="form-control" id="internal_phone_number" name="internal_phone_number">
            <option>no data from server</option>
          </select>
        </div>

        <div class="col-xs-2 div_external_phone_number">
          <label for="external_phone_number">Esterno</label>
          <select class="form-control" id="external_phone_number" name="external_phone_number">
            <option>no data from server</option>
          </select>
        </div>

        <div class="col-xs-2 div_customer_contact">
          <label for="customer_contact">Contatto cliente</label>
          <div class="dropdown">
            <input type="text" id="customer_contact" name="customer_contact" />
          </div>
        </div>

        <div class="col-xs-2 div_call_type">
          <label for="call_type">Risposta/Non risposta</label>
          <select class="form-control" id="status" name="status">
            <option></option>
            <option>N.R. da richiamare</option>
            <option>N.R. evase</option>
            <option>non risposta</option>
            <option>risposta</option>
            <option>occupato</option>
          </select>
        </div>
      </div>
      <div class="form-group row"></div>
      <div class="col-xs-2 div_btn_search">
        <label for="trova"></label>
        <div class="dropdown">
          <button id="btn_search" type="button" class="btn btn-primary">Trova</button>
        </div>
      </div>
  </div>
  </form>

  <div id="calls_search_results" style="margin-top: 100px">
    <table id="calls_search_results_table" class="table table-striped table-bordered" style="width:100%">
      <thead>
        <tr>
          <th></th>
          <th>Orario</th>
          <th>Durata</th>
          <th>Chiamato</th>
          <th>Chiamante</th>
          <th>Destinazione</th>
          <th>Tipo</th>
          <th>Stato</th>
        </tr>
      </thead>
      <tbody>

      </tbody>
      <tfoot>
        <tr>
          <th></th>
          <th>Orario</th>
          <th>Durata</th>
          <th>Chiamato</th>
          <th>Chiamante</th>
          <th>Destinazione</th>
          <th>Tipo</th>
          <th>Stato</th>
        </tr>
      </tfoot>
    </table>
  </div>

  
  <p class="bottom-text"> Copyright - WIFINETCOM SRL 2018</p>
  </div>

  <script type="text/javascript">

    $(document).ready(function () {

      //Bind ajax events
      $(document).ajaxStart(function () {                    
          $("#btn_search").prop("disabled",true);
          $("#modal_wait_for_search").show();
          setTimeout(function(){ }, 3000); 
        });
      $(document).ajaxComplete(function () {          
          $("#btn_search").prop("disabled",false);
          $("#modal_wait_for_search").hide();                  
        });
      $(document).ajaxStop(function () {
          $("#btn_search").prop("disabled",false);
          $("#modal_wait_for_search").hide();          
        });


      moment().format("DD/MM/YYYY hh:mm A");

      $('#start_date').datetimepicker({ locale: 'IT' });
      $('#end_date').datetimepicker({ locale: 'IT' });

      var table_calls = $('#calls_search_results_table').DataTable({
        dom: 'Bfrtip',
        buttons: [
          'copy', 'csv', 'excel', 'pdf', 'print'
        ],
        "columns": [
          {
            "className": 'details-control',
            "orderable": false,
            "data": null,
            "defaultContent": ''
          },
          { "data": "begin" },
          { "data": "duration" },
          { "data": "called" },
          { "data": "caller" },
          { "data": "dst" },
          { "data": "type" },
          { "data": "status" },
        ],
      });

      $('#calls_search_results_table tbody').on('click', 'td.details-control', function () {
        var tr = $(this).closest('tr');
        var row = table_calls.row(tr);

        if (row.child.isShown()) {
          // This row is already open - close it
          row.child.hide();
          tr.removeClass('shown');
        }
        else {
          var element = row.data();
          console.log(element);
          var call_convs = format_conversations(element);
          var call_flow = format_callflow(element);
          var child_text=call_convs+call_flow;
          if(element.status=="RISPOSTA") child_text=call_flow;
          // Open this row
          row.child(child_text).show();
          tr.addClass('shown');
        }
      });

      $.get('/config/internal_phone_number_list', function (data) {
        console.log("Getting data for internal phone number.");
        $('#internal_phone_number').contents().remove();
        $('#internal_phone_number').append($('<option></option>'));
        for (var j = 0; j < data.length; j++) {
          var newOption = $('<option>' + data[j].username + '</option>');
          $('#internal_phone_number').append(newOption);
        }
      });

      $.get('/config/external_phone_number_list', function (data) {
        console.log("Getting data for external phone number.");
        $('#external_phone_number').contents().remove();
        $('#external_phone_number').append($('<option></option>'));
        for (var j = 0; j < data.length; j++) {
          var newOption = $('<option>' + data[j] + '</option>');
          $('#external_phone_number').append(newOption);
        }
      });
    });

    $("#btn_search").click(function () {
      var t = $('#calls_search_results_table').DataTable();
      t.clear().draw();

      var myform = document.getElementById("SearchCalls");
      var fd = new FormData(myform);

      $.ajax({
        url: "/search_calls",
        data: fd,
        cache: false,
        processData: false,
        contentType: false,
        type: 'POST',
        success: function (result_query) {
          //Clear old values
          t.clear();
          result_query.forEach(element => {

            //format date in human redeable
            var d = new Date(element.begin);
            element.begin = moment(element.begin).format('DD/MM/YYYY HH:mm:ss');

            //mark call if related conversations exist
            if ((!element.conversations) && (element.status === "NO ANSWER" || element.status === "BUSY"))
              element.begin += "<br><strong>da ricontattare</strong>";
            else if ((element.conversations) && (element.status === "NO ANSWER" || element.status === "BUSY"))
              element.begin += "<br><strong>cliente ricontattato</strong>";
            else if(element.status==="ANSWERED")
              element.begin += "<br><strong>cliente contattato</strong>";

            //Translate in italian type
            element.type = element.type.replace(/incoming/g, "ingresso");
            element.type = element.type.replace(/outgoing/g, "uscita");
            //Translate in italian status
            element.status = element.status.replace(/ANSWERED/g, "RISPOSTA");
            element.status = element.status.replace(/NO ANSWER/g, "NON RISPOSTA");
            element.status = element.status.replace(/BUSY/g, "OCCUPATO")

            t.row.add(element).draw("false");
          });
        }
      });
    });

    function format_conversations(data_row) {
      var conversations = data_row.conversations;
      //Parse conversation
      var str_conversations = "<p><h5><strong>Altre conversazioni associate</strong></h5></p>";
      if (conversations) {
        console.log("Altre conversazioni associate n.:" + conversations.length);
        for (var i = 0; i < conversations.length; i++) {
          //Data formatting
          var d = new Date(conversations[i].begin);
          conversations[i].begin = moment(conversations[i].begin).format('DD/MM/YYYY HH:mm:ss');
          //type formatting
          if (conversations[i].type === "outgoing") conversations[i].type = "<strong>USCITA</strong>";
          if (conversations[i].type === "incoming") conversations[i].type = "<strong>INGRESSO</strong>";
          //status formatting
          if (conversations[i].status === "ANSWERED") conversations[i].status = "<strong>RISPOSTA</strong>";
          if (conversations[i].status === "NO ANSWER") conversations[i].status = "<strong>NON RISPOSTA</strong>";
          if (conversations[i].status === "BUSY") conversations[i].status = "<strong>OCCUPATO</strong>";

          str_conversations += "<p>inizio: " + conversations[i].begin + " ";
          str_conversations += "durata: " + conversations[i].duration + " ";
          str_conversations += "destinatario: " + conversations[i].caller + "->";
          str_conversations += "chiamante: " + conversations[i].called + " ";
          str_conversations += "stato: " + conversations[i].status + " ";
          str_conversations += "tipo: " + conversations[i].type + "</p>";
        }
        return "<div>" + str_conversations + "</div>";
      }
      str_conversations += "<div><p>chiamata non risposta non ci sono state conversazioni ulteriori</p><strong>Da ricontattare !!!</strong></div>";
      return str_conversations;
    }

    function format_callflow(data_row) {

      var enc = new TextDecoder("utf-8");
      var arrayBuffer = new Uint8Array(data_row.calldata.data).buffer;
      var call_data = enc.decode(arrayBuffer);
      call_data_obj = JSON.parse(call_data);
      var call_flow = call_data_obj.callflow;

      //Parse call flow
      console.log("Lunghezza flusso chiamata :" + call_flow.length)
      str_flow = "<p><h5><strong>Inizio flusso chiamata</strong></h5>";
      if (call_flow[0].dst && call_flow[0].stato)
        str_flow += "<p> >" + call_flow[0].dst + "(" + call_flow[0].stato + ")" + "> </p>";
      for (var i = 0; i < call_flow.length - 1; i++) {
        //Pulizia dei comandi ripetuti correzione bug segnalato a Timenet gestione delle code
        if ((call_flow[i].dst !== call_flow[i + 1].dst) ||
          (call_flow[i].stato !== call_flow[i + 1].stato)) {
          if (call_flow[i].dst) call_flow[i].dst = "";
          if (call_flow[i].stato) call_flow[i].stato = "";
          str_flow += "<p> >" + call_flow[i + 1].dst + "(" + call_flow[i + 1].stato + ")" + "> <p>";
        }
      }

      str_flow = str_flow.replace(/ANSWERED/g, "RISPOSTA");
      str_flow = str_flow.replace(/NO ANSWER/g, "NON RISPOSTA");
      str_flow = str_flow.replace(/BUSY/g, "OCCUPATO");
      // `d` is the original data object for the row
      return '<div>' + str_flow + '</div>';
    }


  </script>
</body>

</html>